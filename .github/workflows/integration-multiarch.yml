name: Multi-Architecture Integration Tests

# STATUS: Manual-only workflow
#
# This workflow is disabled from automatic triggers due to CI infrastructure
# limitations. ARM64 builds under QEMU emulation are too slow for practical
# CI use - Rust compilation alone takes 45+ minutes and times out.
#
# LOCAL TESTING VERIFIED: All 7 integration tests pass on both amd64 and arm64
# when run locally on native hardware (Apple Silicon).
#
# TO RUN MANUALLY: Use "Actions" tab > "Multi-Architecture Integration Tests" > "Run workflow"
#
# FUTURE OPTIONS:
# - Use GitHub's ARM64 runners (ubuntu-24.04-arm) when budget allows
# - Cross-compile to ARM64 without emulation
# - Use self-hosted ARM64 runners
#
on:
  workflow_dispatch:
    inputs:
      skip_arm64:
        description: 'Skip ARM64 tests (faster, amd64 only)'
        required: false
        default: false
        type: boolean

# Restrict permissions for security (OSSF Scorecard requirement)
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  integration-amd64:
    name: Integration Tests (linux/amd64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test containers (amd64)
        run: |
          docker compose -f docker-compose.test-multiarch.yaml build --no-cache
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64

      - name: Start test environment
        run: |
          docker compose -f docker-compose.test-multiarch.yaml up -d
          ./test/scripts/wait-for-healthy.sh
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
          COMPOSE_FILE: docker-compose.test-multiarch.yaml

      - name: Verify PAM module is loaded
        run: |
          docker compose -f docker-compose.test-multiarch.yaml exec -T test-host \
            ls -la /usr/lib/security/libpam_unix_oidc.so

      - name: Verify agent binary works
        run: |
          docker compose -f docker-compose.test-multiarch.yaml exec -T test-host \
            /usr/local/bin/unix-oidc-agent --version

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ldap-utils

      - name: Run integration tests
        run: ./test/scripts/run-integration-tests.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.test-multiarch.yaml logs > integration-logs-amd64.txt
          tail -200 integration-logs-amd64.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: integration-logs-amd64
          path: integration-logs-amd64.txt

      - name: Stop test environment
        if: always()
        run: docker compose -f docker-compose.test-multiarch.yaml down -v

  integration-arm64:
    name: Integration Tests (linux/arm64)
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_arm64 }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test containers (arm64)
        run: |
          docker compose -f docker-compose.test-multiarch.yaml build --no-cache
        env:
          DOCKER_DEFAULT_PLATFORM: linux/arm64
        timeout-minutes: 45

      - name: Start test environment
        run: |
          docker compose -f docker-compose.test-multiarch.yaml up -d
          sleep 60
          ./test/scripts/wait-for-healthy.sh
        env:
          DOCKER_DEFAULT_PLATFORM: linux/arm64
          COMPOSE_FILE: docker-compose.test-multiarch.yaml
        timeout-minutes: 10

      - name: Verify architecture
        run: |
          docker compose -f docker-compose.test-multiarch.yaml exec -T test-host \
            uname -m | grep -E "(aarch64|arm64)"

      - name: Verify PAM module is loaded
        run: |
          docker compose -f docker-compose.test-multiarch.yaml exec -T test-host \
            ls -la /usr/lib/security/libpam_unix_oidc.so

      - name: Verify agent binary works
        run: |
          docker compose -f docker-compose.test-multiarch.yaml exec -T test-host \
            /usr/local/bin/unix-oidc-agent --version

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ldap-utils

      - name: Run integration tests
        run: ./test/scripts/run-integration-tests.sh
        timeout-minutes: 15

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.test-multiarch.yaml logs > integration-logs-arm64.txt
          tail -200 integration-logs-arm64.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: integration-logs-arm64
          path: integration-logs-arm64.txt

      - name: Stop test environment
        if: always()
        run: docker compose -f docker-compose.test-multiarch.yaml down -v

  integration-complete:
    name: Multi-Arch Integration Complete
    runs-on: ubuntu-latest
    needs: [integration-amd64, integration-arm64]
    if: always()
    steps:
      - name: Check results
        env:
          AMD64_RESULT: ${{ needs.integration-amd64.result }}
          ARM64_RESULT: ${{ needs.integration-arm64.result }}
        run: |
          echo "AMD64 result: $AMD64_RESULT"
          echo "ARM64 result: $ARM64_RESULT"

          # AMD64 must pass
          if [ "$AMD64_RESULT" == "failure" ]; then
            echo "AMD64 integration tests failed"
            exit 1
          fi

          # ARM64 can be skipped or must pass
          if [ "$ARM64_RESULT" == "failure" ]; then
            echo "ARM64 integration tests failed"
            exit 1
          fi

          if [ "$ARM64_RESULT" == "skipped" ]; then
            echo "ARM64 tests skipped (--skip_arm64 was set)"
          fi

          echo "All requested integration tests passed"
