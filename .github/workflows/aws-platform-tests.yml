name: AWS Platform Tests

# SECURITY: Manual trigger only - prevents abuse and controls costs
# Environment protection requires your approval before any AWS resources are created
on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        type: choice
        options:
          - amazon-linux-2023
          - amazon-linux-2
          - all
        default: amazon-linux-2023
      instance_type:
        description: 'Instance type (cost control)'
        required: true
        type: choice
        options:
          - t3.micro
          - t3.small
        default: t3.small

# Minimal permissions - OIDC token only
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  INSTANCE_TIMEOUT: 2700  # 45 minutes max

jobs:
  # ==========================================================================
  # Pre-flight: Estimate costs and confirm
  # ==========================================================================
  preflight:
    name: Pre-flight Check
    runs-on: ubuntu-latest
    outputs:
      estimated_cost: ${{ steps.estimate.outputs.cost }}
      platforms: ${{ steps.matrix.outputs.platforms }}
    env:
      INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}
      INPUT_PLATFORM: ${{ inputs.platform }}
    steps:
      - name: Estimate cost
        id: estimate
        run: |
          # Spot pricing (approximate)
          if [ "$INPUT_INSTANCE_TYPE" = "t3.micro" ]; then
            HOURLY_RATE=0.003
          else
            HOURLY_RATE=0.006
          fi

          # ~30 minutes per platform
          HOURS=0.5

          case "$INPUT_PLATFORM" in
            all) PLATFORMS=2 ;;
            *)   PLATFORMS=1 ;;
          esac

          COST=$(echo "$HOURLY_RATE * $HOURS * $PLATFORMS" | bc -l)
          echo "cost=$COST" >> $GITHUB_OUTPUT
          echo "### Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "- Instance type: $INPUT_INSTANCE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: $PLATFORMS" >> $GITHUB_STEP_SUMMARY
          echo "- Estimated cost: \$${COST}" >> $GITHUB_STEP_SUMMARY

      - name: Build platform matrix
        id: matrix
        run: |
          case "$INPUT_PLATFORM" in
            all)
              echo 'platforms=["amazon-linux-2023","amazon-linux-2"]' >> $GITHUB_OUTPUT
              ;;
            amazon-linux-2023)
              echo 'platforms=["amazon-linux-2023"]' >> $GITHUB_OUTPUT
              ;;
            amazon-linux-2)
              echo 'platforms=["amazon-linux-2"]' >> $GITHUB_OUTPUT
              ;;
          esac

  # ==========================================================================
  # Test on AWS EC2
  # ==========================================================================
  test:
    name: Test (${{ matrix.platform }})
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Hard limit for cost control

    # SECURITY: Requires environment approval (configured in GitHub settings)
    environment: aws-testing

    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.preflight.outputs.platforms) }}
        include:
          - platform: amazon-linux-2023
            ami_parameter: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64
            pkg_manager: dnf
            pam_dev: pam-devel
            rust_install: system  # AL2023 has recent Rust in repos
          - platform: amazon-linux-2
            ami_parameter: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
            pkg_manager: yum
            pam_dev: pam-devel
            rust_install: rustup  # AL2 needs rustup for recent Rust

    env:
      GITHUB_REPO: ${{ github.repository }}
      GITHUB_SHA: ${{ github.sha }}
      GITHUB_RUN_ID: ${{ github.run_id }}
      INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: unix-oidc-test-${{ github.run_id }}

      - name: Resolve AMI
        id: ami
        env:
          AMI_PARAMETER: ${{ matrix.ami_parameter }}
        run: |
          AMI_ID=$(aws ssm get-parameter \
            --name "$AMI_PARAMETER" \
            --query 'Parameter.Value' \
            --output text)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Using AMI: $AMI_ID"

      - name: Get security group
        id: sg
        run: |
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=tag:Project,Values=unix-oidc-ci" "Name=group-name,Values=unix-oidc-ci-test-instances" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT
          echo "Using security group: $SG_ID"

      - name: Launch spot instance
        id: ec2
        env:
          AMI_ID: ${{ steps.ami.outputs.ami_id }}
          PLATFORM: ${{ matrix.platform }}
          SECURITY_GROUP_ID: ${{ steps.sg.outputs.sg_id }}
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type "$INPUT_INSTANCE_TYPE" \
            --instance-market-options 'MarketType=spot,SpotOptions={SpotInstanceType=one-time,InstanceInterruptionBehavior=terminate}' \
            --iam-instance-profile Name=unix-oidc-ci-instance-profile \
            --security-group-ids "$SECURITY_GROUP_ID" \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Project,Value=unix-oidc-ci},{Key=Platform,Value=$PLATFORM},{Key=GitHubRun,Value=$GITHUB_RUN_ID}]" \
            --metadata-options 'HttpTokens=required' \
            --query 'Instances[0].InstanceId' \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched instance: $INSTANCE_ID"

          # Wait for instance to be ready
          echo "Waiting for instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids "$INSTANCE_ID"
          echo "Instance is ready"

      - name: Build and test PAM module
        id: test
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          PKG_MANAGER: ${{ matrix.pkg_manager }}
          PAM_DEV: ${{ matrix.pam_dev }}
          RUST_INSTALL: ${{ matrix.rust_install }}
        run: |
          # Build the test script - using heredoc with <<- to strip leading tabs
          cat > /tmp/test-script.sh <<'EOF'
          #!/bin/bash
          set -e

          # Ensure HOME is set (SSM RunShellScript may not set it)
          export HOME=$(getent passwd $(whoami) | cut -d: -f6)

          echo "=== System Info ==="
          echo "Running as user: $(whoami)"
          echo "HOME directory: $HOME"
          cat /etc/os-release
          uname -a
          EOF

          # Append package-specific commands (variables expanded on runner)
          cat >> /tmp/test-script.sh <<EOF
          echo "=== Installing dependencies ==="
          sudo $PKG_MANAGER install -y git $PAM_DEV openssl-devel gcc make pkg-config

          echo "=== Installing Rust (method: $RUST_INSTALL) ==="
          if [ "$RUST_INSTALL" = "system" ]; then
            # Use system packages (faster, AL2023)
            sudo $PKG_MANAGER install -y rust cargo
          else
            # Use rustup (AL2 needs newer Rust)
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            export PATH="\$HOME/.cargo/bin:\$PATH"
          fi

          # Verify cargo is available
          echo "Cargo location: \$(which cargo)"
          cargo --version

          echo "=== Cloning repository ==="
          git clone https://github.com/$GITHUB_REPO.git /tmp/unix-oidc
          cd /tmp/unix-oidc
          git checkout $GITHUB_SHA

          echo "=== Building PAM module ==="
          cargo build --release -p pam-unix-oidc 2>&1

          echo "=== Running tests ==="
          cargo test --release -p pam-unix-oidc 2>&1

          echo "=== Verifying PAM module ==="
          ls -la target/release/libpam_unix_oidc.so
          file target/release/libpam_unix_oidc.so

          echo "=== Installing PAM module ==="
          sudo cp target/release/libpam_unix_oidc.so /lib64/security/ 2>/dev/null || \\
          sudo cp target/release/libpam_unix_oidc.so /lib/security/

          echo "=== SUCCESS: PAM module built and installed ==="
          EOF

          # Remove leading whitespace from script (heredoc preserves YAML indentation)
          sed -i 's/^          //' /tmp/test-script.sh

          # Debug: show the script
          echo "=== Script content ==="
          head -5 /tmp/test-script.sh

          # Create JSON input file for SSM (avoids shell quoting issues)
          jq -n --arg script "$(cat /tmp/test-script.sh)" \
            --arg instance "$INSTANCE_ID" \
            --arg timeout "$INSTANCE_TIMEOUT" \
            '{
              InstanceIds: [$instance],
              DocumentName: "AWS-RunShellScript",
              TimeoutSeconds: ($timeout | tonumber),
              Parameters: {commands: [$script]}
            }' > /tmp/ssm-command.json

          # Send command to instance using SSM
          COMMAND_ID=$(aws ssm send-command \
            --cli-input-json file:///tmp/ssm-command.json \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Command ID: $COMMAND_ID"

          # Wait for command to complete
          echo "Waiting for command to complete..."
          for i in {1..90}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            case $STATUS in
              Success)
                echo "Command succeeded!"
                break
                ;;
              Failed|Cancelled|TimedOut)
                echo "Command failed with status: $STATUS"
                # Get error output
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query 'StandardErrorContent' \
                  --output text || true
                exit 1
                ;;
              *)
                echo "Status: $STATUS (attempt $i/90)"
                sleep 20
                ;;
            esac
          done

          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text

      - name: Cleanup instance
        if: always()
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
        run: |
          if [ -n "$INSTANCE_ID" ]; then
            echo "Terminating instance $INSTANCE_ID..."
            aws ec2 terminate-instances --instance-ids "$INSTANCE_ID" || true
          fi

      - name: Report results
        if: always()
        env:
          PLATFORM: ${{ matrix.platform }}
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          AMI_ID: ${{ steps.ami.outputs.ami_id }}
          TEST_OUTCOME: ${{ steps.test.outcome }}
        run: |
          echo "### Test Results: $PLATFORM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_OUTCOME" = "success" ]; then
            echo "✅ **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Instance: $INSTANCE_ID" >> $GITHUB_STEP_SUMMARY
          echo "- AMI: $AMI_ID" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: Summary
    needs: [preflight, test]
    if: always()
    runs-on: ubuntu-latest
    env:
      ESTIMATED_COST: ${{ needs.preflight.outputs.estimated_cost }}
    steps:
      - name: Generate summary
        run: |
          echo "## AWS Platform Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Cost | \$$ESTIMATED_COST |" >> $GITHUB_STEP_SUMMARY
