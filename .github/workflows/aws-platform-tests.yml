name: AWS Platform Tests

# SECURITY: Manual trigger only - prevents abuse and controls costs
# Environment protection requires your approval before any AWS resources are created
on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test (debian-12/rocky-9 need setup - see workflow comments)'
        required: true
        type: choice
        options:
          - amazon-linux-2023
          - amazon-linux-2
          - rhel-9
          - ubuntu-22.04
          - all
        default: amazon-linux-2023
      instance_type:
        description: 'Instance type (cost control)'
        required: true
        type: choice
        options:
          - t3.micro
          - t3.small
        default: t3.small

# Minimal permissions - OIDC token only
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  INSTANCE_TIMEOUT: 2700  # 45 minutes max

jobs:
  # ==========================================================================
  # Pre-flight: Estimate costs and confirm
  # ==========================================================================
  preflight:
    name: Pre-flight Check
    runs-on: ubuntu-latest
    outputs:
      estimated_cost: ${{ steps.estimate.outputs.cost }}
      platforms: ${{ steps.matrix.outputs.platforms }}
    env:
      INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}
      INPUT_PLATFORM: ${{ inputs.platform }}
    steps:
      - name: Estimate cost
        id: estimate
        run: |
          # Spot pricing (approximate)
          if [ "$INPUT_INSTANCE_TYPE" = "t3.micro" ]; then
            HOURLY_RATE=0.003
          else
            HOURLY_RATE=0.006
          fi

          # ~30 minutes per platform
          HOURS=0.5

          case "$INPUT_PLATFORM" in
            all) PLATFORMS=4 ;;  # AL2023, AL2, RHEL9, Ubuntu (debian-12/rocky-9 excluded)
            *)   PLATFORMS=1 ;;
          esac

          COST=$(echo "$HOURLY_RATE * $HOURS * $PLATFORMS" | bc -l)
          echo "cost=$COST" >> $GITHUB_OUTPUT
          echo "### Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "- Instance type: $INPUT_INSTANCE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: $PLATFORMS" >> $GITHUB_STEP_SUMMARY
          echo "- Estimated cost: \$${COST}" >> $GITHUB_STEP_SUMMARY

      - name: Build platform matrix
        id: matrix
        run: |
          case "$INPUT_PLATFORM" in
            all)
              # Note: debian-12 and rocky-9 require additional setup:
              # - Rocky 9: needs AWS Marketplace subscription
              # - Debian 12: SSM Agent not pre-installed, user-data install unreliable
              echo 'platforms=["amazon-linux-2023","amazon-linux-2","rhel-9","ubuntu-22.04"]' >> $GITHUB_OUTPUT
              ;;
            amazon-linux-2023)
              echo 'platforms=["amazon-linux-2023"]' >> $GITHUB_OUTPUT
              ;;
            amazon-linux-2)
              echo 'platforms=["amazon-linux-2"]' >> $GITHUB_OUTPUT
              ;;
            rhel-9)
              echo 'platforms=["rhel-9"]' >> $GITHUB_OUTPUT
              ;;
            ubuntu-22.04)
              echo 'platforms=["ubuntu-22.04"]' >> $GITHUB_OUTPUT
              ;;
            # debian-12 and rocky-9 removed - see workflow comments for setup instructions
          esac

  # ==========================================================================
  # Test on AWS EC2
  # ==========================================================================
  test:
    name: Test (${{ matrix.platform }})
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Hard limit for cost control

    # SECURITY: Requires environment approval (configured in GitHub settings)
    environment: aws-testing

    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.preflight.outputs.platforms) }}
        include:
          - platform: amazon-linux-2023
            ami_parameter: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64
            ami_type: ssm
            pkg_manager: dnf
            pam_dev: pam-devel
          - platform: amazon-linux-2
            ami_parameter: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
            ami_type: ssm
            pkg_manager: yum
            pam_dev: pam-devel
          - platform: rhel-9
            ami_owner: "309956199498"
            ami_filter: "RHEL-9.*_HVM-*-x86_64-*-Hourly2-GP3"
            ami_type: marketplace
            pkg_manager: dnf
            pam_dev: pam-devel
            needs_ssm_install: true
          - platform: ubuntu-22.04
            ami_owner: "099720109477"
            ami_filter: "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
            ami_type: marketplace
            pkg_manager: apt
            pam_dev: libpam0g-dev
          # Note: debian-12 and rocky-9 are commented out - they require additional setup:
          # - Rocky 9: needs AWS Marketplace subscription at https://aws.amazon.com/marketplace/pp?sku=3qk9e6x2ni81uiqnorll45r3f
          # - Debian 12: SSM Agent not pre-installed, user-data installation unreliable
          # Uncomment below after completing the required setup:
          # - platform: debian-12
          #   ami_owner: "136693071363"
          #   ami_filter: "debian-12-amd64-*"
          #   ami_type: marketplace
          #   pkg_manager: apt
          #   pam_dev: libpam0g-dev
          #   needs_ssm_install: true
          # - platform: rocky-9
          #   ami_owner: "679593333241"
          #   ami_filter: "Rocky-9-EC2-Base-*x86_64*"
          #   ami_type: marketplace
          #   pkg_manager: dnf
          #   pam_dev: pam-devel
          #   needs_ssm_install: true

    env:
      GITHUB_REPO: ${{ github.repository }}
      GITHUB_SHA: ${{ github.sha }}
      GITHUB_RUN_ID: ${{ github.run_id }}
      INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: unix-oidc-test-${{ github.run_id }}

      - name: Resolve AMI
        id: ami
        env:
          AMI_TYPE: ${{ matrix.ami_type }}
          AMI_PARAMETER: ${{ matrix.ami_parameter }}
          AMI_OWNER: ${{ matrix.ami_owner }}
          AMI_FILTER: ${{ matrix.ami_filter }}
        run: |
          if [ "$AMI_TYPE" = "ssm" ]; then
            # Amazon Linux uses SSM parameter store
            AMI_ID=$(aws ssm get-parameter \
              --name "$AMI_PARAMETER" \
              --query 'Parameter.Value' \
              --output text)
          else
            # RHEL uses marketplace AMI lookup
            AMI_ID=$(aws ec2 describe-images \
              --owners "$AMI_OWNER" \
              --filters "Name=name,Values=$AMI_FILTER" \
                        "Name=state,Values=available" \
              --query "sort_by(Images, &CreationDate)[-1].ImageId" \
              --output text)
          fi
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Using AMI: $AMI_ID"

      - name: Get security group
        id: sg
        run: |
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=tag:Project,Values=unix-oidc-ci" "Name=group-name,Values=unix-oidc-ci-test-instances" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT
          echo "Using security group: $SG_ID"

      - name: Launch spot instance
        id: ec2
        env:
          AMI_ID: ${{ steps.ami.outputs.ami_id }}
          PLATFORM: ${{ matrix.platform }}
          SECURITY_GROUP_ID: ${{ steps.sg.outputs.sg_id }}
          NEEDS_SSM_INSTALL: ${{ matrix.needs_ssm_install || 'false' }}
          PKG_MANAGER: ${{ matrix.pkg_manager }}
        run: |
          # Build user-data script for SSM Agent installation
          if [ "$NEEDS_SSM_INSTALL" = "true" ]; then
            echo '#!/bin/bash' > /tmp/user-data.sh
            echo "# Install SSM Agent on $PLATFORM" >> /tmp/user-data.sh

            if [ "$PKG_MANAGER" = "apt" ]; then
              # Debian-based: download .deb with curl (pre-installed) and install with dpkg
              echo 'set -x' >> /tmp/user-data.sh
              echo 'exec > /var/log/user-data.log 2>&1' >> /tmp/user-data.sh
              echo '# Wait for cloud-init to complete and apt locks to be released' >> /tmp/user-data.sh
              echo 'cloud-init status --wait || true' >> /tmp/user-data.sh
              echo 'while fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done' >> /tmp/user-data.sh
              echo 'while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done' >> /tmp/user-data.sh
              echo 'curl -sL https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb -o /tmp/amazon-ssm-agent.deb' >> /tmp/user-data.sh
              echo 'dpkg -i /tmp/amazon-ssm-agent.deb' >> /tmp/user-data.sh
            else
              # RHEL/Rocky: install RPM directly with dnf
              echo 'dnf install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm' >> /tmp/user-data.sh
            fi

            echo 'systemctl enable amazon-ssm-agent' >> /tmp/user-data.sh
            echo 'systemctl start amazon-ssm-agent' >> /tmp/user-data.sh
            USER_DATA_B64=$(base64 -w0 /tmp/user-data.sh)
            USER_DATA_ARG="--user-data $USER_DATA_B64"
          else
            USER_DATA_ARG=""
          fi

          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type "$INPUT_INSTANCE_TYPE" \
            --instance-market-options 'MarketType=spot,SpotOptions={SpotInstanceType=one-time,InstanceInterruptionBehavior=terminate}' \
            --iam-instance-profile Name=unix-oidc-ci-instance-profile \
            --security-group-ids "$SECURITY_GROUP_ID" \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Project,Value=unix-oidc-ci},{Key=Platform,Value=$PLATFORM},{Key=GitHubRun,Value=$GITHUB_RUN_ID}]" \
            --metadata-options 'HttpTokens=required' \
            $USER_DATA_ARG \
            --query 'Instances[0].InstanceId' \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched instance: $INSTANCE_ID"

          # Wait for instance to be ready
          echo "Waiting for instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids "$INSTANCE_ID"

          # Wait extra time for SSM Agent to start on platforms that need installation
          if [ "$NEEDS_SSM_INSTALL" = "true" ]; then
            echo "Waiting for SSM Agent to start on $PLATFORM..."
            sleep 90

            # Verify SSM Agent is ready by checking managed instances
            echo "Verifying SSM Agent connectivity..."
            for i in {1..10}; do
              SSM_STATUS=$(aws ssm describe-instance-information \
                --filters "Key=InstanceIds,Values=$INSTANCE_ID" \
                --query 'InstanceInformationList[0].PingStatus' \
                --output text 2>/dev/null || echo "NotReady")
              if [ "$SSM_STATUS" = "Online" ]; then
                echo "SSM Agent is online!"
                break
              fi
              echo "SSM Status: $SSM_STATUS (attempt $i/10)"
              sleep 15
            done
          fi
          echo "Instance is ready"

      - name: Build and test PAM module
        id: test
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          PKG_MANAGER: ${{ matrix.pkg_manager }}
          PAM_DEV: ${{ matrix.pam_dev }}
        run: |
          # Build the test script - using heredoc with <<- to strip leading tabs
          cat > /tmp/test-script.sh <<'EOF'
          #!/bin/bash
          set -e

          # Ensure HOME is set (SSM RunShellScript may not set it)
          export HOME=$(getent passwd $(whoami) | cut -d: -f6)

          echo "=== System Info ==="
          echo "Running as user: $(whoami)"
          echo "HOME directory: $HOME"
          cat /etc/os-release
          uname -a
          EOF

          # Determine SSL development package and update command based on package manager
          if [ "$PKG_MANAGER" = "apt" ]; then
            SSL_DEV="libssl-dev"
            BUILD_TOOLS="build-essential curl"
            UPDATE_CMD="sudo apt-get update &&"
          else
            SSL_DEV="openssl-devel"
            BUILD_TOOLS="gcc make"
            UPDATE_CMD=""
          fi

          # Append package-specific commands (variables expanded on runner)
          cat >> /tmp/test-script.sh <<EOF
          echo "=== Installing dependencies ==="
          export DEBIAN_FRONTEND=noninteractive
          $UPDATE_CMD sudo $PKG_MANAGER install -y git $PAM_DEV $SSL_DEV $BUILD_TOOLS pkg-config

          echo "=== Installing Rust ==="
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          export PATH="\$HOME/.cargo/bin:\$PATH"

          # Verify cargo is available
          echo "Cargo location: \$(which cargo)"
          cargo --version

          echo "=== Cloning repository ==="
          git clone https://github.com/$GITHUB_REPO.git /tmp/unix-oidc
          cd /tmp/unix-oidc
          git checkout $GITHUB_SHA

          echo "=== Building PAM module ==="
          cargo build --release -p pam-unix-oidc 2>&1

          echo "=== Running tests ==="
          cargo test --release -p pam-unix-oidc 2>&1

          echo "=== Verifying PAM module ==="
          ls -la target/release/libpam_unix_oidc.so
          file target/release/libpam_unix_oidc.so

          echo "=== Installing PAM module ==="
          sudo cp target/release/libpam_unix_oidc.so /lib64/security/ 2>/dev/null || \\
          sudo cp target/release/libpam_unix_oidc.so /lib/x86_64-linux-gnu/security/ 2>/dev/null || \\
          sudo cp target/release/libpam_unix_oidc.so /lib/security/

          echo "=== SUCCESS: PAM module built and installed ==="
          EOF

          # Remove leading whitespace from script (heredoc preserves YAML indentation)
          sed -i 's/^          //' /tmp/test-script.sh

          # Debug: show the script
          echo "=== Script content ==="
          head -5 /tmp/test-script.sh

          # Create JSON input file for SSM (avoids shell quoting issues)
          jq -n --arg script "$(cat /tmp/test-script.sh)" \
            --arg instance "$INSTANCE_ID" \
            --arg timeout "$INSTANCE_TIMEOUT" \
            '{
              InstanceIds: [$instance],
              DocumentName: "AWS-RunShellScript",
              TimeoutSeconds: ($timeout | tonumber),
              Parameters: {commands: [$script]}
            }' > /tmp/ssm-command.json

          # Send command to instance using SSM
          COMMAND_ID=$(aws ssm send-command \
            --cli-input-json file:///tmp/ssm-command.json \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Command ID: $COMMAND_ID"

          # Wait for command to complete
          echo "Waiting for command to complete..."
          for i in {1..90}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            case $STATUS in
              Success)
                echo "Command succeeded!"
                break
                ;;
              Failed|Cancelled|TimedOut)
                echo "Command failed with status: $STATUS"
                # Get error output
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query 'StandardErrorContent' \
                  --output text || true
                exit 1
                ;;
              *)
                echo "Status: $STATUS (attempt $i/90)"
                sleep 20
                ;;
            esac
          done

          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text

      - name: Cleanup instance
        if: always()
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
        run: |
          if [ -n "$INSTANCE_ID" ]; then
            echo "Terminating instance $INSTANCE_ID..."
            aws ec2 terminate-instances --instance-ids "$INSTANCE_ID" || true
          fi

      - name: Report results
        if: always()
        env:
          PLATFORM: ${{ matrix.platform }}
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          AMI_ID: ${{ steps.ami.outputs.ami_id }}
          TEST_OUTCOME: ${{ steps.test.outcome }}
        run: |
          echo "### Test Results: $PLATFORM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_OUTCOME" = "success" ]; then
            echo "✅ **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Instance: $INSTANCE_ID" >> $GITHUB_STEP_SUMMARY
          echo "- AMI: $AMI_ID" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: Summary
    needs: [preflight, test]
    if: always()
    runs-on: ubuntu-latest
    env:
      ESTIMATED_COST: ${{ needs.preflight.outputs.estimated_cost }}
    steps:
      - name: Generate summary
        run: |
          echo "## AWS Platform Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Cost | \$$ESTIMATED_COST |" >> $GITHUB_STEP_SUMMARY
