name: ARM64 Integration Tests (AWS)

# SECURITY: Manual trigger only - prevents abuse and controls costs
# Uses native ARM64 (Graviton) instances for fast, reliable testing
on:
  workflow_dispatch:
    inputs:
      instance_type:
        description: 'Instance type'
        required: true
        type: choice
        options:
          - t4g.small
          - t4g.medium
        default: t4g.small

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  AMI_NAME_PREFIX: unix-oidc-ci-arm64
  INSTANCE_TIMEOUT: 1800  # 30 minutes max

jobs:
  preflight:
    name: Pre-flight Check
    runs-on: ubuntu-latest
    outputs:
      ami_id: ${{ steps.ami.outputs.ami_id }}
      estimated_cost: ${{ steps.estimate.outputs.cost }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: unix-oidc-arm64-preflight-${{ github.run_id }}

      - name: Find latest ARM64 AMI
        id: ami
        run: |
          AMI_ID=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=name,Values=$AMI_NAME_PREFIX-*" "Name=tag:Project,Values=unix-oidc-ci" "Name=state,Values=available" \
            --query 'sort_by(Images, &CreationDate)[-1].ImageId' \
            --output text)

          if [ -z "$AMI_ID" ] || [ "$AMI_ID" = "None" ]; then
            echo "::error::No ARM64 test AMI found. Run the 'Build ARM64 Test AMI' workflow first."
            exit 1
          fi

          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Found AMI: $AMI_ID"

      - name: Estimate cost
        id: estimate
        env:
          INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}
        run: |
          # Spot pricing (approximate)
          case "$INPUT_INSTANCE_TYPE" in
            t4g.small)  HOURLY_RATE=0.005 ;;
            t4g.medium) HOURLY_RATE=0.010 ;;
            *)          HOURLY_RATE=0.010 ;;
          esac

          # ~15 minutes per run
          HOURS=0.25
          COST=$(echo "$HOURLY_RATE * $HOURS" | bc -l)

          echo "cost=$COST" >> $GITHUB_OUTPUT
          echo "### Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "- Instance type: $INPUT_INSTANCE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- Estimated cost: \$${COST}" >> $GITHUB_STEP_SUMMARY

  test:
    name: Integration Tests (ARM64)
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # SECURITY: Requires environment approval
    environment: aws-testing

    env:
      AMI_ID: ${{ needs.preflight.outputs.ami_id }}
      INPUT_INSTANCE_TYPE: ${{ inputs.instance_type }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: unix-oidc-arm64-test-${{ github.run_id }}

      - name: Get security group
        id: sg
        run: |
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=tag:Project,Values=unix-oidc-ci" "Name=group-name,Values=unix-oidc-ci-test-instances" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT

      - name: Launch test instance
        id: ec2
        env:
          SG_ID: ${{ steps.sg.outputs.sg_id }}
          GH_RUN_ID: ${{ github.run_id }}
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type "$INPUT_INSTANCE_TYPE" \
            --instance-market-options 'MarketType=spot,SpotOptions={SpotInstanceType=one-time,InstanceInterruptionBehavior=terminate}' \
            --iam-instance-profile Name=unix-oidc-ci-instance-profile \
            --security-group-ids "$SG_ID" \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Project,Value=unix-oidc-ci},{Key=Purpose,Value=arm64-integration-test},{Key=GitHubRun,Value=$GH_RUN_ID}]" \
            --metadata-options 'HttpTokens=required' \
            --query 'Instances[0].InstanceId' \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched instance: $INSTANCE_ID"

          # Wait for instance to be ready
          echo "Waiting for instance..."
          aws ec2 wait instance-status-ok --instance-ids "$INSTANCE_ID"
          echo "Instance is ready"

      - name: Run integration tests
        id: test
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          GH_REPO: ${{ github.repository }}
          GH_SHA: ${{ github.sha }}
        run: |
          # Create test script with variables substituted
          cat > /tmp/test-script.sh <<EOF
          #!/bin/bash
          set -e

          echo "=== System Info ==="
          uname -a
          cat /etc/os-release
          docker --version
          docker-compose --version

          echo "=== Clone repository ==="
          cd /tmp
          git clone https://github.com/$GH_REPO.git unix-oidc
          cd unix-oidc
          git checkout $GH_SHA

          echo "=== Start test infrastructure ==="
          docker-compose -f docker-compose.test.yaml up -d

          echo "=== Wait for services ==="
          sleep 30

          echo "=== Check service status ==="
          docker-compose -f docker-compose.test.yaml ps

          echo "=== Install Rust ==="
          export HOME=/root
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source /root/.cargo/env

          echo "=== Build PAM module ==="
          cargo build --release -p pam-unix-oidc

          echo "=== Run unit tests ==="
          cargo test --release -p pam-unix-oidc

          echo "=== Verify PAM module ==="
          file target/release/libpam_unix_oidc.so
          ls -la target/release/libpam_unix_oidc.so

          echo "=== Run integration tests ==="
          # Check Keycloak is responding
          curl -sf http://localhost:8080/health/ready || echo "Keycloak health check"

          # Check OpenLDAP is responding
          docker-compose -f docker-compose.test.yaml exec -T openldap ldapsearch -x -H ldap://localhost -b "dc=test,dc=local" -D "cn=admin,dc=test,dc=local" -w admin "(objectClass=*)" || echo "LDAP check"

          echo "=== Cleanup ==="
          docker-compose -f docker-compose.test.yaml down -v

          echo "=== SUCCESS ==="
          EOF

          # Create JSON input for SSM (avoids shell quoting issues)
          jq -n --arg cmds "$(cat /tmp/test-script.sh)" --arg instance "$INSTANCE_ID" --arg timeout "$INSTANCE_TIMEOUT" \
            '{InstanceIds: [$instance], DocumentName: "AWS-RunShellScript", TimeoutSeconds: ($timeout | tonumber), Parameters: {commands: [$cmds]}}' \
            > /tmp/ssm-input.json

          # Send test script via SSM
          COMMAND_ID=$(aws ssm send-command \
            --cli-input-json file:///tmp/ssm-input.json \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Test command: $COMMAND_ID"

          # Wait for completion
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            case $STATUS in
              Success)
                echo "Tests passed!"
                break
                ;;
              Failed|Cancelled|TimedOut)
                echo "Tests failed: $STATUS"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query 'StandardErrorContent' \
                  --output text || true
                exit 1
                ;;
              *)
                echo "Status: $STATUS ($i/60)"
                sleep 30
                ;;
            esac
          done

          # Get test output
          echo "=== Test Output ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text

      - name: Cleanup instance
        if: always()
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
        run: |
          if [ -n "$INSTANCE_ID" ]; then
            echo "Terminating instance..."
            aws ec2 terminate-instances --instance-ids "$INSTANCE_ID" || true
          fi

      - name: Report results
        if: always()
        env:
          TEST_OUTCOME: ${{ steps.test.outcome }}
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
        run: |
          echo "### ARM64 Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_OUTCOME" = "success" ]; then
            echo "**PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Instance: $INSTANCE_ID" >> $GITHUB_STEP_SUMMARY
          echo "- AMI: $AMI_ID" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Summary
    needs: [preflight, test]
    if: always()
    runs-on: ubuntu-latest
    env:
      ESTIMATED_COST: ${{ needs.preflight.outputs.estimated_cost }}
    steps:
      - name: Generate summary
        run: |
          echo "## ARM64 Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Cost | \$$ESTIMATED_COST |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Result | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
